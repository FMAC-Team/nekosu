#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later

SRC_DIR="test"
CONFIG_H="include/config.h"

mkdir -p "$(dirname "$CONFIG_H")"
echo "#ifndef _TEST_CONFIG_H" > "$CONFIG_H"
echo "#define _TEST_CONFIG_H" >> "$CONFIG_H"
echo "Generating config.h based on compilation check..."

for srcfile in "$SRC_DIR"/*.c; do
    [ -f "$srcfile" ] || continue
    base=$(basename "$srcfile" .c)
    macro="HAVE_${base^^}"

    tmpdir=$(mktemp -d)
    tmpmake="$tmpdir/Makefile"
    rpath_src=$(realpath "$srcfile")

    cat > "$tmpmake" <<EOF
KDIR := \$(KDIR)
MDIR := \$(realpath \$(dir \$(abspath \$(lastword \$(MAKEFILE_LIST)))))
IDIR := \$(MDIR)/include

all:
	make -C \$(KDIR) M=\$(MDIR) modules 
EOF

 #   if make -C "$tmpdir" >/dev/null 2>&1; then
 if make -C "$tmpdir" ; then
        echo "  [+] $base compiled successfully"
        echo "#define $macro 1" >> "$CONFIG_H"
    else
        echo "  [-] $base failed to compile"
        echo "/* #undef $macro */" >> "$CONFIG_H"
    fi

  #  rm -rf "$tmpdir"
done

echo "#endif" >> "$CONFIG_H"
echo "Generated $CONFIG_H"